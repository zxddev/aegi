<!-- Author: msq -->

# 设计理念

## 1. 核心哲学

- **先数据结构后代码**：先把核心数据与边界定义清楚，再写逻辑。数据结构对了，代码自然简洁。
- **好品味（Good Taste）**：从不同角度看问题，重写它让特殊情况消失。经典案例：链表删除 10 行带 if → 4 行无分支。消除边界情况永远优于增加条件判断。
- **Never break userspace**：已发布的 API/接口，破坏性改动默认视为 bug，必须有迁移方案。内部接口（未发布）允许快速迭代，但需在 PR 中标注影响范围。
- **实用主义**：解决真实问题，不是假想的威胁。拒绝"理论完美"但实际复杂的方案。
- **简洁执念**：函数短小，只做一件事。缩进层级过深通常是抽象错了——但 Python 的 `async with` + `try` + `for` 天然 3 层，不必机械计数，关注的是**认知复杂度**而非物理缩进。
- **依赖方向单一**：高层模块不依赖低层实现细节；通过接口/协议（Protocol）隔离。禁止循环依赖。
- **Fail fast**：前置校验，尽早暴露错误。不要用深层嵌套的防御性代码掩盖问题。
- **可观测性内建**：关键路径必须有结构化日志和指标，不要等出了问题再加。
- **Make the implicit explicit**：隐式的业务规则、依赖关系、副作用都应该显式化。如果一个行为需要"你得知道"才能理解，那就是设计缺陷。
- **Design for change**：假设需求会变，选择容易修改的结构。小模块、清晰接口、避免跨模块隐式耦合。不是过度设计，而是让当前结构改得动。
- **Composition over inheritance**：用组合 + `Protocol`（结构化子类型）代替继承层次。继承超过 2 层就该警惕。
- **基础稳、上层敢**：基础设施层（存储、网络、框架）用成熟技术不折腾；本体层和 AI Agent 层鼓励创新突破——这是 aegi 超越 Palantir 的战场，不能保守。

## 2. 决策输出模板（架构/方案/大改时使用）

```
【核心判断】
✅ 值得做 / ❌ 不值得做

【关键洞察】
- 数据结构：...
- 复杂度：...
- 风险点：...

【方案】
1. ...
2. ...

【验证方式】
- 用什么命令/指标证明它是对的：...
```

## 3. Linus 式分析框架（设计/排错/评审时使用）

1. **数据结构**：核心数据是什么？谁拥有？谁修改？
2. **特殊情况**：哪些 if/else 是业务必需，哪些是糟糕建模的补丁？能否通过抽象消除？
3. **复杂度**：概念数量是否过多？模块边界是否清晰？
4. **破坏性**：会破坏什么？现有接口/行为/依赖如何兼容？
5. **实用性**：问题是否真实存在？投入产出是否匹配？

## 4. 沟通与输出要求

- 结论明确、可验证、可复现。
- 代码/文档注释一律中文，表述工程化，避免拟人化或 AI 口吻。
- 不确定点必须点名询问用户，不自行猜测关键决策。
- 批评针对技术，不针对人；但不为"友善"而模糊技术判断。
