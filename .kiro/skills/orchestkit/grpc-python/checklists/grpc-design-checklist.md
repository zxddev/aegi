# gRPC API Design Checklist

Best practices for designing gRPC service APIs.

## Proto File Organization

- [ ] **proto3 syntax** - Use `syntax = "proto3";` (never proto2 for new services)
- [ ] **Versioned package** - `package domain.service.v1;`
- [ ] **Python package option** - `option python_package = "app.protos.service_v1";`
- [ ] **One service per file** - Better maintainability and code generation
- [ ] **Shared messages in common.proto** - Reuse across services
- [ ] **Import well-known types** - `google/protobuf/timestamp.proto`, `empty.proto`

## Service Definition

- [ ] **Verb + Noun naming** - `GetUser`, `CreateOrder`, `ListProducts`
- [ ] **Consistent naming pattern**:
  - `Get{Resource}` - Single resource by ID
  - `List{Resources}` - Collection with pagination
  - `Create{Resource}` - Create new resource
  - `Update{Resource}` - Update existing resource
  - `Delete{Resource}` - Remove resource
  - `Watch{Resources}` - Real-time updates (server streaming)
- [ ] **Request/Response naming** - `{MethodName}Request`, `{MethodName}Response`
- [ ] **Streaming where appropriate**:
  - Server streaming for large lists or real-time updates
  - Client streaming for bulk operations
  - Bidirectional for chat/sync scenarios

## Message Design

- [ ] **Field numbers are forever** - Never reuse deleted field numbers
- [ ] **Reserve deleted fields** - `reserved 5, 6; reserved "old_field";`
- [ ] **Use optional for nullable** - `optional string middle_name = 3;`
- [ ] **Enum zero = UNSPECIFIED** - `ENUM_NAME_UNSPECIFIED = 0;`
- [ ] **Timestamps for dates** - `google.protobuf.Timestamp created_at = 10;`
- [ ] **Duration for intervals** - `google.protobuf.Duration timeout = 11;`
- [ ] **Wrapper types for nullable primitives** - `google.protobuf.Int32Value` if null vs 0 matters
- [ ] **oneof for polymorphism** - Mutually exclusive fields

## Pagination

- [ ] **Cursor-based pagination** - `page_token` string, not offset
- [ ] **page_size field** - With server-enforced maximum
- [ ] **next_page_token in response** - Empty when no more pages
- [ ] **total_count optional** - Only if efficiently computable

```protobuf
message ListUsersRequest {
  int32 page_size = 1;          // Max items per page
  string page_token = 2;        // Opaque cursor from previous response
}

message ListUsersResponse {
  repeated User users = 1;
  string next_page_token = 2;   // Empty if no more pages
}
```

## Error Handling

- [ ] **Use standard status codes** - `INVALID_ARGUMENT`, `NOT_FOUND`, `ALREADY_EXISTS`
- [ ] **Rich error details** - `google.rpc.BadRequest` for validation errors
- [ ] **Error messages in English** - Client handles localization
- [ ] **Include request_id** - For debugging and correlation

| Scenario | gRPC Status Code |
|----------|------------------|
| Validation failed | `INVALID_ARGUMENT` |
| Resource not found | `NOT_FOUND` |
| Duplicate resource | `ALREADY_EXISTS` |
| Permission denied | `PERMISSION_DENIED` |
| Rate limited | `RESOURCE_EXHAUSTED` |
| Server error | `INTERNAL` |
| Not implemented | `UNIMPLEMENTED` |

## Field Masks (Partial Updates)

- [ ] **Use FieldMask for updates** - `google.protobuf.FieldMask update_mask`
- [ ] **Document which fields are mutable** - Comments in proto

```protobuf
message UpdateUserRequest {
  string user_id = 1;
  User user = 2;
  google.protobuf.FieldMask update_mask = 3;  // e.g., "name,email"
}
```

## Versioning Strategy

- [ ] **Package version** - `package user.v1;`, `package user.v2;`
- [ ] **Backward compatible by default** - Add fields, don't remove
- [ ] **New version for breaking changes** - v2, v3, etc.
- [ ] **Deprecate, don't delete** - `[deprecated = true]` on old fields

## Security

- [ ] **No secrets in messages** - Passwords, tokens in metadata only
- [ ] **Input validation documented** - Field constraints in comments
- [ ] **Rate limiting by method** - Document in service comments
- [ ] **Sensitive fields marked** - For logging/tracing exclusion

## Documentation

- [ ] **Service-level comments** - What this service does
- [ ] **Method comments** - What each RPC does, error conditions
- [ ] **Field comments** - Format, constraints, examples
- [ ] **Examples in comments** - Sample request/response

```protobuf
// UserService manages user accounts.
// Rate limit: 100 requests per minute per client.
service UserService {
  // GetUser returns a user by ID.
  // Returns NOT_FOUND if user doesn't exist.
  rpc GetUser(GetUserRequest) returns (User);
}

message User {
  // Unique identifier (UUID format).
  // Output only - generated by server.
  string id = 1;

  // Email address (must be valid format).
  // Required for creation, immutable after.
  string email = 2;
}
```

## Code Generation

- [ ] **buf lint** - Validate proto style
- [ ] **buf breaking** - Detect breaking changes
- [ ] **Type stubs generated** - `--pyi_out` for Python type hints
- [ ] **Generated code in gitignore** - Or committed consistently

```bash
# Recommended buf.yaml
version: v1
lint:
  use:
    - DEFAULT
breaking:
  use:
    - FILE
```

## Anti-Patterns to Avoid

- [ ] **NO embedded JSON strings** - Use proper nested messages
- [ ] **NO reusing field numbers** - Even after deletion
- [ ] **NO required fields** - Everything optional in proto3
- [ ] **NO mutable field semantics** - Field 5 always means the same thing
- [ ] **NO generic catch-all fields** - `map<string, Any> metadata`
